{"version":3,"sources":["../src/epict_ctrl.js"],"names":["MetricsPanelCtrl","TimeSeries","_","scaleQuantize","panelDefaults","bgColor","boxes","EpictCtrl","$scope","$injector","defaultsDeep","panel","events","on","onInitEditMode","bind","onPanelTeardown","onDataReceived","onDataSnapshotLoad","render","addEditorTab","processedBgURL","templateSrv","replace","bgURL","scopedVars","self","scope","ctrl","forEach","box","URL","processedURL","usingThresholds","rawValue","parseInt","thresholds","split","color","colorLow","blinkLow","isBlinking","colorHigh","blinkHigh","colorMedium","panelData","series","map","seriesHandler","wantedSerie","filter","oneSerie","alias","serie","datapoints","length","nf","Intl","NumberFormat","numberBeforeFormatting","toFixed","decimal","formattedNumber","format","text","snapshotData","seriesData","target","flotpairs","getFlotPairs","nullPointMode","push","xpos","ypos","fontsize","prefixSize","suffixSize","hasOrb","orbSize","orbHideText","orbLocation","console","log","$index","Object","assign","splice","e","ctrlKey","alert","offsetX","offsetY","elem","$panelContainer","find","css","templateUrl"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;AAAQA,MAAAA,gB,kBAAAA,gB;;AACDC,MAAAA,U;;AACAC,MAAAA,C;;AACEC,MAAAA,a,MAAAA,a;;;AAEHC,MAAAA,a,GAAgB;AACpBC,QAAAA,OAAO,EAAE,IADW;AAEpBC,QAAAA,KAAK,EAAE;AAFa,O;;2BAKTC,S;;;;;AACX,2BAAYC,MAAZ,EAAoBC,SAApB,EAA+B;AAAA;;AAAA;;AAC7B,yFAAMD,MAAN,EAAcC,SAAd;;AACAP,UAAAA,CAAC,CAACQ,YAAF,CAAe,MAAKC,KAApB,EAA2BP,aAA3B;;AAGA,gBAAKQ,MAAL,CAAYC,EAAZ,CAAe,gBAAf,EAAiC,MAAKC,cAAL,CAAoBC,IAApB,+BAAjC;;AACA,gBAAKH,MAAL,CAAYC,EAAZ,CAAe,gBAAf,EAAiC,MAAKG,eAAL,CAAqBD,IAArB,+BAAjC;;AACA,gBAAKH,MAAL,CAAYC,EAAZ,CAAe,eAAf,EAAgC,MAAKI,cAAL,CAAoBF,IAApB,+BAAhC;;AACA,gBAAKH,MAAL,CAAYC,EAAZ,CAAe,oBAAf,EAAqC,MAAKK,kBAAL,CAAwBH,IAAxB,+BAArC;;AACA,gBAAKH,MAAL,CAAYC,EAAZ,CAAe,mBAAf,EAAoC,MAAKM,MAAL,CAAYJ,IAAZ,+BAApC;;AACA,gBAAKH,MAAL,CAAYC,EAAZ,CAAe,QAAf,EAAwB,MAAKM,MAAL,CAAYJ,IAAZ,+BAAxB;;AAV6B;AAW9B;;;;2CAEgB;AACf,iBAAKK,YAAL,CAAkB,SAAlB,EAA6B,+CAA7B,EAA8E,CAA9E;AACD;;;4CAEiB,CACjB;;;mCAEO;AACT,iBAAKC,cAAL,GAAoB,KAAKC,WAAL,CAAiBC,OAAjB,CAAyB,KAAKZ,KAAL,CAAWa,KAApC,EAA2C,KAAKb,KAAL,CAAWc,UAAtD,CAApB;AACA,gBAAIC,IAAI,GAAC,IAAT;AACA,iBAAKC,KAAL,CAAWC,IAAX,CAAgBjB,KAAhB,CAAsBL,KAAtB,CAA4BuB,OAA5B,CAAoC,UAASC,GAAT,EAAa;AAChD,kBAAGA,GAAG,CAACC,GAAP,EAAW;AACVD,gBAAAA,GAAG,CAACE,YAAJ,GAAiBN,IAAI,CAACJ,WAAL,CAAiBC,OAAjB,CAAyBO,GAAG,CAACC,GAA7B,EAAkCL,IAAI,CAACf,KAAL,CAAWc,UAA7C,CAAjB;AACA;;AACD,kBAAGK,GAAG,CAACG,eAAJ,IAAqB,IAAxB,EAA6B;AACrB,oBAAGH,GAAG,CAACI,QAAJ,IAAeC,QAAQ,CAACL,GAAG,CAACM,UAAJ,CAAeC,KAAf,CAAqB,GAArB,EAA0B,CAA1B,CAAD,CAA1B,EAAyD;AAC/DP,kBAAAA,GAAG,CAACQ,KAAJ,GAAUR,GAAG,CAACS,QAAd;;AACA,sBAAGT,GAAG,CAACU,QAAP,EAAgB;AACfV,oBAAAA,GAAG,CAACW,UAAJ,GAAe,IAAf;AACA,mBAFD,MAEK;AACJX,oBAAAA,GAAG,CAACW,UAAJ,GAAe,KAAf;AACA;AACD,iBAPM,MAOD,IAAGX,GAAG,CAACI,QAAJ,IAAeC,QAAQ,CAACL,GAAG,CAACM,UAAJ,CAAeC,KAAf,CAAqB,GAArB,EAA0B,CAA1B,CAAD,CAA1B,EAAyD;AAC9DP,kBAAAA,GAAG,CAACQ,KAAJ,GAAUR,GAAG,CAACY,SAAd;;AACA,sBAAGZ,GAAG,CAACa,SAAP,EAAiB;AAChBb,oBAAAA,GAAG,CAACW,UAAJ,GAAe,IAAf;AACA,mBAFD,MAEK;AACJX,oBAAAA,GAAG,CAACW,UAAJ,GAAe,KAAf;AACA;AACD,iBAPK,MAOD;AACJX,kBAAAA,GAAG,CAACQ,KAAJ,GAAUR,GAAG,CAACc,WAAd;AACAd,kBAAAA,GAAG,CAACW,UAAJ,GAAe,KAAf;AACA,iBAlB2B,CAmB5B;;AACA,eApBD,MAoBK;AACJX,gBAAAA,GAAG,CAACW,UAAJ,GAAe,KAAf;AACA;AACD,aA3BD,EAHS,CAgCV;AACG;;;yCAEcI,S,EAAW;AAAA;;AAExB;AACA,iBAAKC,MAAL,GAAcD,SAAS,CAACE,GAAV,CAAc,KAAKC,aAAL,CAAmBjC,IAAnB,CAAwB,IAAxB,CAAd,CAAd,CAHwB,CAIxB;AACA;;AACA,iBAAKJ,KAAL,CAAWL,KAAX,CAAiBuB,OAAjB,CAAyB,UAAAC,GAAG,EAAI;AAC/B,kBAAImB,WAAW,GAAG,MAAI,CAACH,MAAL,CAAYI,MAAZ,CAAmB,UAAUC,QAAV,EAAoB;AACtD,uBAAOA,QAAQ,CAACC,KAAT,IAAkBtB,GAAG,CAACuB,KAA7B;AACD,eAFgB,CAAlB;;AAGC,kBAAGJ,WAAW,IAAI,IAAf,IAAuBA,WAAW,CAAC,CAAD,CAAX,IAAgB,IAAvC,IAA+CA,WAAW,CAAC,CAAD,CAAX,CAAeK,UAAf,CAA0BC,MAA1B,IAAkC,CAApF,EACA;AACL,oBAAGN,WAAW,CAAC,CAAD,CAAX,CAAeK,UAAf,CAA0BL,WAAW,CAAC,CAAD,CAAX,CAAeK,UAAf,CAA0BC,MAA1B,GAAmC,CAA7D,EAAgE,CAAhE,KAAoE,IAAvE,EAA4E;AAC3E,sBAAIC,EAAE,GAAG,IAAIC,IAAI,CAACC,YAAT,EAAT;AACO,sBAAIC,sBAAsB,GAACV,WAAW,CAAC,CAAD,CAAX,CAAeK,UAAf,CAA0BL,WAAW,CAAC,CAAD,CAAX,CAAeK,UAAf,CAA0BC,MAA1B,GAAmC,CAA7D,EAAgE,CAAhE,EAAmEK,OAAnE,CAA2E9B,GAAG,CAAC+B,OAA/E,CAA3B;AACA/B,kBAAAA,GAAG,CAACI,QAAJ,GAAae,WAAW,CAAC,CAAD,CAAX,CAAeK,UAAf,CAA0BL,WAAW,CAAC,CAAD,CAAX,CAAeK,UAAf,CAA0BC,MAA1B,GAAmC,CAA7D,EAAgE,CAAhE,CAAb,CAHoE,CAGa;;AACxF,sBAAIO,eAAe,GAAGN,EAAE,CAACO,MAAH,CAAUJ,sBAAV,CAAtB;AACO7B,kBAAAA,GAAG,CAACkC,IAAJ,GAAWF,eAAX;AACP,iBAND,MAMK;AACJhC,kBAAAA,GAAG,CAACkC,IAAJ,GAAS,GAAT;AACA;AACK,eAXD,MAWK;AACHlC,gBAAAA,GAAG,CAACkC,IAAJ,GAAS,KAAT;AACD,eAjB6B,CAkB9B;AACA;;AACD,aApBD;AAqBA,iBAAK7C,MAAL;AACD;;;6CAEkB8C,Y,EAAc;AAC/B,iBAAKhD,cAAL,CAAoBgD,YAApB;AACD;;;wCAEaC,U,EAAY;AACxB,gBAAMpB,MAAM,GAAG,IAAI7C,UAAJ,CAAe;AAC5BqD,cAAAA,UAAU,EAAEY,UAAU,CAACZ,UAAX,IAAyB,EADT;AAE5BF,cAAAA,KAAK,EAAEc,UAAU,CAACC;AAFU,aAAf,CAAf;AAIArB,YAAAA,MAAM,CAACsB,SAAP,GAAmBtB,MAAM,CAACuB,YAAP,CAAoB,KAAK1D,KAAL,CAAW2D,aAA/B,CAAnB;AAEA,mBAAOxB,MAAP;AACD;;;mCAEO;AACN,iBAAKnC,KAAL,CAAWL,KAAX,CAAiBiE,IAAjB,CAAsB;AAAClB,cAAAA,KAAK,EAAC,UAAP;AAAkBW,cAAAA,IAAI,EAAC,KAAvB;AAA6BQ,cAAAA,IAAI,EAAC,CAAlC;AAAoCC,cAAAA,IAAI,EAAC,CAAzC;AAA2CC,cAAAA,QAAQ,EAAC,EAApD;AAAuDC,cAAAA,UAAU,EAAC,EAAlE;AAAqEC,cAAAA,UAAU,EAAC,EAAhF;AAAmFtC,cAAAA,KAAK,EAAC,MAAzF;AAAgGuB,cAAAA,OAAO,EAAC,CAAxG;AAA0G5B,cAAAA,eAAe,EAAC,KAA1H;AAAgIG,cAAAA,UAAU,EAAC,OAA3I;AAAmJG,cAAAA,QAAQ,EAAC,MAA5J;AAAmKK,cAAAA,WAAW,EAAC,MAA/K;AAAsLF,cAAAA,SAAS,EAAC,MAAhM;AAAwMmC,cAAAA,MAAM,EAAC,KAA/M;AAAsNC,cAAAA,OAAO,EAAC,IAA9N;AAAoOC,cAAAA,WAAW,EAAC,KAAhP;AAAuPC,cAAAA,WAAW,EAAE;AAApQ,aAAtB;AAEAC,YAAAA,OAAO,CAACC,GAAR,CAAY,KAAKvE,KAAL,CAAWL,KAAvB;AACD;;;mCACQ6E,M,EAAO;AACd,iBAAKxE,KAAL,CAAWL,KAAX,CAAiBiE,IAAjB,CAAsBa,MAAM,CAACC,MAAP,CAAc,EAAd,EAAkB,KAAK1E,KAAL,CAAWL,KAAX,CAAiB6E,MAAjB,CAAlB,CAAtB;AACD;;;oCACSA,M,EAAO;AACd,iBAAKxE,KAAL,CAAWL,KAAX,CAAiBgF,MAAjB,CAAwBH,MAAxB,EAA+B,CAA/B;AACF;;;oCACOI,C,EAAE;AACV,gBAAGA,CAAC,CAACC,OAAL,EAAa;AACXC,cAAAA,KAAK,CAAC,OAAKF,CAAC,CAACG,OAAP,GAAe,KAAf,GAAqBH,CAAC,CAACI,OAAxB,CAAL;AACD;AACF;;;+BAEMhE,K,EAAOiE,I,EAAM;AAAA;;AAChB,iBAAKhF,MAAL,CAAYC,EAAZ,CAAe,QAAf,EAAyB,YAAM;AAC7B,kBAAMgF,eAAe,GAAGD,IAAI,CAACE,IAAL,CAAU,kBAAV,CAAxB;;AAEA,kBAAI,MAAI,CAACnF,KAAL,CAAWN,OAAf,EAAwB;AACtBwF,gBAAAA,eAAe,CAACE,GAAhB,CAAoB,kBAApB,EAAwC,MAAI,CAACpF,KAAL,CAAWN,OAAnD;AACD,eAFD,MAEO;AACLwF,gBAAAA,eAAe,CAACE,GAAhB,CAAoB,kBAApB,EAAwC,EAAxC;AACD;AACF,aARD;AASD;;;;QA/H4B/F,gB;;AAkI/BO,MAAAA,SAAS,CAACyF,WAAV,GAAwB,aAAxB","sourcesContent":["import {MetricsPanelCtrl} from 'app/plugins/sdk';\nimport TimeSeries from 'app/core/time_series2';\nimport _ from 'lodash';\nimport { scaleQuantize } from 'd3';\n\nconst panelDefaults = {\n  bgColor: null,\n  boxes: []\n};\n\nexport class EpictCtrl extends MetricsPanelCtrl {\n  constructor($scope, $injector) {\n    super($scope, $injector);\n    _.defaultsDeep(this.panel, panelDefaults);\n\n   \n    this.events.on('init-edit-mode', this.onInitEditMode.bind(this));\n    this.events.on('panel-teardown', this.onPanelTeardown.bind(this));\n    this.events.on('data-received', this.onDataReceived.bind(this));\n    this.events.on('data-snapshot-load', this.onDataSnapshotLoad.bind(this));\n    this.events.on('panel-initialized', this.render.bind(this));\n    this.events.on('render',this.render.bind(this));\n  }\n\n  onInitEditMode() {\n    this.addEditorTab('Options', 'public/plugins/larona-epict-panel/editor.html', 2);\n  }\n\n  onPanelTeardown() {\n  }\n\n  render(){\n\tthis.processedBgURL=this.templateSrv.replace(this.panel.bgURL, this.panel.scopedVars);\n\tvar self=this;\n\tthis.scope.ctrl.panel.boxes.forEach(function(box){\n\t\tif(box.URL){\n\t\t\tbox.processedURL=self.templateSrv.replace(box.URL, self.panel.scopedVars)\n\t\t}\n\t\tif(box.usingThresholds==true){\n        \t\tif(box.rawValue <=parseInt(box.thresholds.split(',')[0])){\n\t\t\t\tbox.color=box.colorLow;\n\t\t\t\tif(box.blinkLow){\n\t\t\t\t\tbox.isBlinking=true\n\t\t\t\t}else{\n\t\t\t\t\tbox.isBlinking=false;\n\t\t\t\t}\n\t\t\t}else if(box.rawValue >=parseInt(box.thresholds.split(',')[1])){\n\t\t\t\tbox.color=box.colorHigh;\n\t\t\t\tif(box.blinkHigh){\n\t\t\t\t\tbox.isBlinking=true\n\t\t\t\t}else{\n\t\t\t\t\tbox.isBlinking=false;\n\t\t\t\t}\n\t\t\t}else{\n\t\t\t\tbox.color=box.colorMedium\n\t\t\t\tbox.isBlinking=false;\n\t\t\t}\n\t\t\t//alert(box.rawValue);\n\t\t}else{\n\t\t\tbox.isBlinking=false;\n\t\t}\n\t});\n\t\n//\talert(\"yes\");\n  }\n\n  onDataReceived(panelData) {\n\n    // console.log(panelData);\n    this.series = panelData.map(this.seriesHandler.bind(this));\n    // console.log(this.series);\n    //Assigner valeur\n    this.panel.boxes.forEach(box => {\n     var wantedSerie = this.series.filter(function (oneSerie) {\n        return oneSerie.alias == box.serie;\n      });\n      if(wantedSerie != null && wantedSerie[0]!=null && wantedSerie[0].datapoints.length!=0)\n      {\n\tif(wantedSerie[0].datapoints[wantedSerie[0].datapoints.length - 1][0]!=null){\n\t\tvar nf = new Intl.NumberFormat();\n        \tvar numberBeforeFormatting=wantedSerie[0].datapoints[wantedSerie[0].datapoints.length - 1][0].toFixed(box.decimal);\n        \tbox.rawValue=wantedSerie[0].datapoints[wantedSerie[0].datapoints.length - 1][0]  //Used to determine the color if the Threshold is enabled\n\t\tvar formattedNumber = nf.format(numberBeforeFormatting);\n        \tbox.text = formattedNumber;\n\t}else{\n\t\tbox.text=\"-\";\n\t}\n      }else{\n        box.text=\"N/A\";\n      } \n      // console.log(wantedSerie);\n      // alert(wantedSerie[0].datapoints[wantedSerie.length-1]);\n    }); \n    this.render();\n  }\n\n  onDataSnapshotLoad(snapshotData) {\n    this.onDataReceived(snapshotData);\n  }\n\n  seriesHandler(seriesData) {\n    const series = new TimeSeries({\n      datapoints: seriesData.datapoints || [],\n      alias: seriesData.target,\n    });\n    series.flotpairs = series.getFlotPairs(this.panel.nullPointMode);\n    \n    return series;\n  }\n\n  addBox(){\n    this.panel.boxes.push({serie:\"A-series\",text:\"N/A\",xpos:0,ypos:0,fontsize:12,prefixSize:10,suffixSize:10,color:\"#000\",decimal:1,usingThresholds:false,thresholds:'20,60',colorLow:\"#0f0\",colorMedium:\"#fa1\",colorHigh:\"#f00\", hasOrb:false, orbSize:\"10\", orbHideText:false, orbLocation: \"Left\"});\n    \n    console.log(this.panel.boxes);\n  }\n  cloneBox($index){\n    this.panel.boxes.push(Object.assign({}, this.panel.boxes[$index]));\n  }\n  deleteBox($index){\n     this.panel.boxes.splice($index,1);\n  }\nclicktest(e){\n  if(e.ctrlKey){\n    alert(\"X:\"+e.offsetX+\" Y:\"+e.offsetY);\n  }\n}\n\n  link(scope, elem) {\n    this.events.on('render', () => {\n      const $panelContainer = elem.find('.panel-container');\n\n      if (this.panel.bgColor) {\n        $panelContainer.css('background-color', this.panel.bgColor);\n      } else {\n        $panelContainer.css('background-color', '');\n      }\n    });\n  }\n}\n\nEpictCtrl.templateUrl = 'module.html';\n"],"file":"epict_ctrl.js"}